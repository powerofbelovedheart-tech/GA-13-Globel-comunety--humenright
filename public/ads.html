<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <title>Annonser | GA-13</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    @media(max-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:820px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:520px){.grid{grid-template-columns:1fr}}
    .adcard img{width:100%;height:180px;object-fit:cover;border-radius:10px}
    .toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
    .toolbar input,.toolbar select{height:36px}
  </style>
</head>
<body>
<header class="container">
  <h1>Annonser</h1>
  <nav>
    <a href="index.html">Hjem</a>
    <a href="ads.html" class="active">Annonser</a>
    <a href="new-ad.html">Ny annonse</a>
  </nav>
</header>
<!-- Ett annonsekort (template) -->
<div class="ad-card" data-id="{{ID}}">
  <img src="{{IMG}}" alt="">
  <div class="ad-body">
    <h3>{{TITLE}}</h3>
    <p class="price">{{PRICE}} kr</p>
    <p class="meta">{{CATEGORY}} • {{LOCATION}}</p>

    <div class="ad-actions">
      <a class="btn" href="/ad.html?id={{ID}}">Se detaljer</a>
      <button class="btn-like" data-id="{{ID}}" title="Legg til/fjern favoritt">♡</button>
    </div>
  </div>
</div>
<main class="container">
  <div class="toolbar">
    <input id="q" placeholder="Søk…" />
    <input id="min" type="number" min="0" placeholder="Min pris" style="width:120px" />
    <input id="max" type="number" min="0" placeholder="Max pris" style="width:120px" />
    <select id="sort">
      <option value="new">Nyeste</option>
      <option value="price_asc">Pris ↑</option>
      <option value="price_desc">Pris ↓</option>
    </select>
    <button id="btnFilter">Filtrer</button>
  </div>

  <div id="ads" class="grid"></div>
</main>

<script>
async function loadAds() {
  const q = document.getElementById("q").value.trim();
  const min = document.getElementById("min").value.trim();
  const max = document.getElementById("max").value.trim();
  const sort = document.getElementById("sort").value;

  const params = new URLSearchParams();
  if (q) params.set("query", q);
  if (min) params.set("min", min);
  if (max) params.set("max", max);
  if (sort) params.set("sort", sort);

  const res = await fetch("/api/ads?" + params.toString());
  const items = await res.json();

  const wrap = document.getElementById("ads");
  wrap.innerHTML = "";
  items.forEach(a => {
    const img = (a.images && a.images[0]) ? a.images[0] : "https://via.placeholder.com/600x400?text=Ingen+bilde";
    const el = document.createElement("a");
    el.className = "card adcard";
    el.href = "ad.html?id=" + encodeURIComponent(a.id);
    el.innerHTML = `
      <img src="${img}" alt="">
      <h3>${escapeHtml(a.title || "")}</h3>
      <p class="muted">${(a.price || 0).toLocaleString("no-NO")} kr</p>
    `;
    wrap.appendChild(el);
  });
}
document.getElementById("btnFilter").addEventListener("click", loadAds);

function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]))}
loadAds();

<script>
const AUTH_EMAIL = localStorage.getItem("ga13_email"); // samme som tidligere "innlogging light"
async function toggleFavorite(id, btn) {
  if (!AUTH_EMAIL) { alert("Logg inn for å bruke favoritter."); return; }
  try {
    const active = btn.classList.contains("active");
    const method = active ? "DELETE" : "POST";
    const res = await fetch(`/api/favorites/${id}`, {
      method,
      headers: {
        "Content-Type":"application/json",
        "Authorization": "Bearer " + AUTH_EMAIL
      }
    });
    if (!res.ok) throw new Error((await res.json()).error||"Feil");
    btn.classList.toggle("active");
    btn.textContent = btn.classList.contains("active") ? "♥" : "♡";
  } catch (e) {
    alert("Klarte ikke oppdatere favoritt: " + e.message);
  }
}

// Knytt alle knapper
document.addEventListener("click", (e) => {
  const btn = e.target.closest(".btn-like");
  if (!btn) return;
  const id = btn.dataset.id;
  toggleFavorite(id, btn);
});
</script>

</body>
</html>