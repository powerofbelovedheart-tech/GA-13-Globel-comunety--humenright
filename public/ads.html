<!doctype html><html lang="no"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mine annonser • GA-13</title>
<link rel="stylesheet" href="/style.css">
</head><body>
<header class="site-header"><div class="wrap">
  <h1>Mine annonser</h1>
  <nav class="main-nav">
    <a href="/">Forside</a>
    <a href="/market.html">Kjøp & salg</a>
    <a class="btn" href="/new-ad.html">Ny annonse</a>
  </nav>
</div></header>

<main class="wrap">
  <section class="card" style="margin-bottom:16px">
    <form id="ownerForm" style="display:flex;gap:8px;flex-wrap:wrap">
      <input id="owner" name="owner" type="email" required placeholder="din@epost.no" style="flex:1;min-width:260px;padding:10px">
      <button class="btn" type="submit">Vis mine</button>
    </form>
    <p class="muted" style="margin-top:6px">* Midlertidig løsning uten innlogging – filtrerer på e-postfeltet <code>owner</code>.</p>
  </section>

  <section id="grid" class="grid"></section>
</main>

<script>
const grid = document.getElementById('grid');
const ownerInput = document.getElementById('owner');
const ownerForm = document.getElementById('ownerForm');

// Husk sist brukt e-post lokalt
ownerInput.value = localStorage.getItem('ga13_owner') || '';

ownerForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const owner = ownerInput.value.trim();
  if(!owner) return;
  localStorage.setItem('ga13_owner', owner);
  load(owner);
});

async function load(owner){
  const res = await fetch('/api/ads?search=' + encodeURIComponent(owner));
  const ads = (await res.json()).filter(a => (a.owner||'').toLowerCase() === owner.toLowerCase());
  grid.innerHTML = ads.map(a => card(a)).join('') || '<p>Ingen annonser funnet for <strong>'+owner+'</strong>.</p>';
}

function formatCurrency(n){try{return new Intl.NumberFormat('no-NO',{style:'currency',currency:'NOK'}).format(n)}catch{return n+' kr'}}

function card(a){
  return `
  <article class="card">
    <img src="${a.imageUrl}" alt="" style="width:100%;max-height:180px;object-fit:cover;border-radius:12px">
    <h3 style="margin:10px 0 4px">${escapeHtml(a.title)}</h3>
    <div class="muted">${escapeHtml(a.category)} • ${escapeHtml(a.location||'')}</div>
    <div style="display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:8px">
      <strong>${formatCurrency(a.price)}</strong>
      <span>
        <a class="btn ghost" href="/edit-ad.html?id=${a.id}">Rediger</a>
        <button class="btn danger" onclick="del('${a.id}')" type="button">Slett</button>
        <a class="btn" href="/ad.html?id=${a.id}">Se</a>
      </span>
    </div>
  </article>`;
}

function escapeHtml(s=''){return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

async function del(id){
  if(!confirm('Slette annonsen?')) return;
  const res = await fetch('/api/ads/'+id,{method:'DELETE'});
  if(!res.ok){ alert('Klarte ikke å slette'); return; }
  // reload
  ownerForm.dispatchEvent(new Event('submit'));
}

// auto-last om owner ligger lagret
if(ownerInput.value) ownerForm.dispatchEvent(new Event('submit'));
</script>
</body></html>